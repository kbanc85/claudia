{
  "hooks": [
    {
      "event": "session_start",
      "description": "Verify memory system, load context, catch up on unsummarized sessions",
      "behavior": {
        "action": "load_memory",
        "files": [
          "context/me.md",
          "context/learnings.md",
          "context/patterns.md",
          "context/commitments.md",
          "context/waiting.md"
        ],
        "on_missing_me": "trigger_onboarding",
        "memory_verification": {
          "step_1_check_tools": "BEFORE anything else, verify you have access to mcp__claudia-memory__* tools (check your available tools list). If no memory tools are available: (1) Do NOT fall back to plugin:episodic-memory, mcp__plugin_episodic-memory_*, or any other memory search tool as a substitute — these give inferior, unrelated results and mask the real problem. (2) Tell the user: 'My memory tools are not registered in this session. The daemon likely just auto-restarted — please restart Claude Code (close and reopen the window) to reconnect. Your context files are preserved.' (3) Continue with context files only (context/me.md, etc.) until restarted.",
          "step_2_health_check": "Call memory.session (operation=\"context\"). If it fails or returns an error, the daemon may be crashed. Suggest: 'Memory daemon may need restart. Check: curl http://localhost:3848/health'",
          "fallback": "If mcp__claudia-memory__* tools are not available: (1) Do NOT use plugin:episodic-memory or any other memory search tool as a substitute. (2) Tell the user: 'My memory tools are not registered in this session. The daemon may have just restarted — please restart Claude Code to reconnect. Your context files are preserved.' (3) Read context files directly (context/me.md, context/commitments.md, context/learnings.md, context/patterns.md, context/waiting.md) as the fallback. Make clear to the user they are in degraded mode with no semantic search or cross-session learning."
        },
        "enhanced_memory": {
          "context_load": "Call memory.session (operation=\"context\") to get a formatted context block with recent memories, commitments, and unsummarized session alerts.",
          "catch_up": "If unsummarized sessions are reported in the context block, review buffered turns and call memory.end_session with a retroactive narrative and structured extractions for each.",
          "recall_context": "Use the loaded context for greeting. For deeper search on specific topics, use memory.recall."
        },
        "proactive_surfacing": {
          "description": "Surface urgent items naturally in the greeting. Keep it to a brief mention, not a full report.",
          "max_items": 3,
          "checks": [
            {
              "type": "overdue_commitments",
              "description": "Commitments older than 7 days without resolution",
              "query_hint": "Use memory.recall with type='commitment' filter and check dates"
            },
            {
              "type": "cooling_relationships",
              "description": "Important people not mentioned in >30 days",
              "query_hint": "Use memory.entities (operation=\"search\") to find entities with old last_mentioned dates"
            }
          ],
          "examples": [
            "By the way, you mentioned sending that proposal to Sarah 10 days ago. Want me to help draft a follow-up?",
            "It's been a while since we talked about Alex. Shall I pull up your latest context?"
          ]
        }
      }
    },
    {
      "event": "session_end",
      "description": "Generate session summary and persist updates",
      "behavior": {
        "action": "save_memory",
        "files": [
          "context/learnings.md",
          "context/patterns.md",
          "context/commitments.md",
          "context/waiting.md"
        ],
        "save_mode": "merge",
        "enhanced_memory": {
          "summarize": "Call memory.end_session with a narrative summary and structured extractions from the session's buffered turns. The narrative should enhance stored information with tone, context, unresolved threads, and nuance that structured fields cannot capture."
        }
      }
    },
    {
      "event": "first_run",
      "description": "Detect first run and trigger onboarding",
      "behavior": {
        "action": "check_file",
        "file": "context/me.md",
        "on_missing": "trigger_skill:onboarding"
      }
    }
  ],
  "notes": {
    "implementation": "These hooks define intended behaviors. Claude Code will execute them as behavioral guidelines rather than traditional script execution.",
    "memory_verification": "CRITICAL: At session start, verify mcp__claudia-memory__* tools are available BEFORE proceeding. If tools don't appear, do NOT use plugin:episodic-memory as a substitute. Tell the user to restart Claude Code — the daemon auto-restarts but MCP tools only register at session start. Fall back to context files only (context/me.md, etc.) in the meantime.",
    "session_start": "At session start: (1) Verify memory tools available, (2) Call memory.session (operation=\"context\"), (3) Read context files, (4) Check for unsummarized sessions. If me.md is missing, trigger onboarding.",
    "session_end": "Before session ends, Claudia should generate a session summary (enhanced memory) or update context files (markdown fallback). The summary includes both a free-form narrative and structured extractions.",
    "first_run": "The absence of context/me.md signals a first-run scenario requiring onboarding.",
    "turn_buffering": "During sessions with enhanced memory, Claudia buffers each meaningful conversation turn via memory.session (operation=\"buffer\"). This ensures nothing is lost even if the session ends abruptly. The buffered turns are summarized at session end or caught up at next session start.",
    "source_filing": "CRITICAL: When processing transcripts, emails, or documents, ALWAYS call memory.document (operation=\"store\") BEFORE extracting information. The Source Preservation principle (#12) is non-negotiable. Raw sources must be filed for provenance."
  }
}
